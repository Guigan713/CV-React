---
# Role: k3s - Installation et configuration de K3s

- name: Vérifier si K3s est déjà installé
  stat:
    path: /usr/local/bin/k3s
  register: k3s_installed

- name: Installer les prérequis
  apt:
    name:
      - curl
      - apt-transport-https
      - ca-certificates
    state: present
    update_cache: yes
  become: yes

- name: Télécharger le script d'installation K3s
  get_url:
    url: https://get.k3s.io
    dest: /tmp/k3s-install.sh
    mode: '0755'
  become: yes

- name: Installer K3s Server (Master)
  shell: |
    INSTALL_K3S_EXEC="server --cluster-init" sh /tmp/k3s-install.sh
  become: yes
  when: 
    - "'masters' in group_names"
    - not k3s_installed.stat.exists

- name: Attendre que le serveur K3s soit prêt
  wait_for:
    path: /etc/rancher/k3s/k3s.yaml
    timeout: 120
  when: "'masters' in group_names"
  become: yes

- name: Récupérer le token du master
  slurp:
    src: /var/lib/rancher/k3s/server/node-token
  register: k3s_node_token
  when: "'masters' in group_names"
  become: yes

- name: Sauvegarder le token comme fact
  set_fact:
    k3s_master_token: "{{ k3s_node_token.content | b64decode | trim }}"
  when: "'masters' in group_names"

- name: Installer K3s Agent (Worker)
  shell: |
    K3S_URL=https://{{ hostvars[groups['masters'][0]]['ansible_host'] }}:6443 \
    K3S_TOKEN={{ hostvars[groups['masters'][0]]['k3s_master_token'] }} \
    sh /tmp/k3s-install.sh
  become: yes
  when: 
    - "'workers' in group_names"
    - not k3s_installed.stat.exists

- name: Créer le répertoire .kube pour l'utilisateur
  file:
    path: "{{ ansible_env.HOME }}/.kube"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  when: "'masters' in group_names"

- name: Copier le fichier kubeconfig
  copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "{{ ansible_env.HOME }}/.kube/config"
    remote_src: yes
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'
  become: yes
  when: "'masters' in group_names"

- name: Nettoyer le script d'installation
  file:
    path: /tmp/k3s-install.sh
    state: absent
  become: yes
